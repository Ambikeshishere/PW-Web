<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PW Live B2B & Target Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
    :root {
        --bg-dark: #020617;
        --card-bg: rgba(15, 23, 42, 0.7);
        --card-border: rgba(56, 189, 248, 0.2);
        --accent-primary: #38bdf8;
        --success: #4ade80;
        --text-main: #f1f5f9;
        --text-muted: #94a3b8;
        --warning: #fb923c;
    }

    * { box-sizing: border-box; }
    
    body {
        margin: 0; padding: 0;
        background: linear-gradient(-45deg, #020617, #0f172a, #1e293b, #020617);
        background-size: 400% 400%;
        animation: gradientBG 15s ease infinite;
        font-family: 'Outfit', sans-serif;
        color: var(--text-main);
        padding-bottom: 40px;
        min-height: 100vh;
    }

    @keyframes gradientBG {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    header { padding: 30px 20px; text-align: center; }
    h1 {
        font-size: 28px; font-weight: 700; margin: 0;
        background: linear-gradient(90deg, #38bdf8, #fb923c);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        text-transform: uppercase; letter-spacing: 1px;
    }

    .container { padding: 15px; max-width: 1400px; margin: 0 auto; }
    .grid { display: grid; gap: 20px; }
    @media(min-width: 768px) { 
        .grid-2 { grid-template-columns: 1fr 1fr; } 
        .grid-3 { grid-template-columns: 1.2fr 1fr 1fr; }
        .grid-4 { grid-template-columns: repeat(4, 1fr); } 
    }

    .card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        backdrop-filter: blur(12px);
        border-radius: 20px; padding: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    .card h3 { 
        margin: 0 0 20px 0; font-size: 16px; font-weight: 600;
        display: flex; align-items: center; gap: 10px;
    }
    .card h3::before { content: ''; width: 4px; height: 18px; background: var(--accent-primary); border-radius: 10px; }

    /* Scrollable Chart Containers */
    .scroll-x-container { width: 100%; overflow-x: auto; overflow-y: hidden; cursor: grab; }
    .scroll-y-container { width: 100%; overflow-y: auto; max-height: 500px; }
    
    .kpi-card { 
        background: rgba(0, 0, 0, 0.3); border-radius: 16px; padding: 15px; 
        text-align: center; border: 1px solid var(--card-border);
    }
    .kpi-label { font-size: 11px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 6px; }
    .kpi-value { font-size: 22px; font-weight: 700; }

    select {
        width: 100%; padding: 12px; border-radius: 12px; background: #0f172a; color: white;
        border: 1px solid var(--card-border); margin-bottom: 20px; font-family: inherit;
    }

    .live-dot {
        height: 10px; width: 10px; background-color: #4ade80;
        border-radius: 50%; display: inline-block; margin-right: 8px;
        box-shadow: 0 0 10px #4ade80;
        animation: pulse 1.5s infinite;
    }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { text-align: left; color: var(--text-muted); padding: 12px 8px; border-bottom: 1px solid var(--card-border); }
    td { padding: 12px 8px; border-bottom: 1px solid rgba(148, 163, 184, 0.05); }
    
    footer { text-align: center; font-size: 12px; color: var(--text-muted); margin-top: 40px; }
</style>
</head>

<body>

<header>
    <h1>PW Maharashtra Performance Engine</h1>
    <div style="font-size:14px; color:#94a3b8; margin-top:8px">
        <span class="live-dot"></span>SYSTEM STATUS: <span style="color:#4ade80">STREAMING LIVE DATA</span>
    </div>
</header>

<div class="container">
    <div class="grid grid-4" style="margin-bottom: 20px;">
        <div class="kpi-card"><div class="kpi-label">Total Target</div><div class="kpi-value" id="tTarget">0</div></div>
        <div class="kpi-card"><div class="kpi-label">Total Achieved</div><div class="kpi-value" style="color:var(--accent-primary)" id="tAch">0</div></div>
        <div class="kpi-card"><div class="kpi-label">Avg Achievement</div><div class="kpi-value" style="color:var(--success)" id="tPct">0%</div></div>
        <div class="kpi-card"><div class="kpi-label">B2B Forms Filled</div><div class="kpi-value" style="color:var(--warning)" id="tB2B">0</div></div>
    </div>

    <div class="card" style="margin-bottom: 20px;">
        <h3>üìà B2B Form Submission Trend (Scroll Right ‚Üí)</h3>
        <div class="scroll-x-container">
            <div style="width: 2500px; height: 350px;"> <canvas id="lineChart"></canvas>
            </div>
        </div>
    </div>

    <div class="grid grid-3">
        <div class="card">
            <h3>üéÆ Center Completion Progress (Target)</h3>
            <div class="scroll-y-container">
                <div style="height: 1200px;"><canvas id="bar"></canvas></div>
            </div>
        </div>

        <div class="card">
            <h3>üéØ Overall Conversion</h3>
            <div style="height:250px; width:100%;"><canvas id="pie"></canvas></div>
            <div style="margin-top: 20px;">
                <div class="kpi-card" style="background:transparent">
                    <div class="kpi-label">Remaining Gap</div>
                    <div class="kpi-value" id="tDelta" style="color:#f87171">0</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>üîç Deep Dive Analysis</h3>
            <select id="centerSelect"><option value="">Detecting Centers...</option></select>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="kpi-card"><div class="kpi-label">Achieved</div><div class="kpi-value" id="cAch" style="font-size:18px">-</div></div>
                <div class="kpi-card"><div class="kpi-label">B2B Filled</div><div class="kpi-value" id="cB2B" style="color:var(--warning); font-size:18px">-</div></div>
            </div>
            <div style="height:180px; width:100%; margin-top:20px"><canvas id="centerPie"></canvas></div>
        </div>
    </div>

    <footer>
        Developed by Ambikesh Srivastava ‚Ä¢ Auto-syncing @ 0.5s ‚Ä¢ LAST HEARTBEAT: <span id="syncTime">--:--:--</span>
    </footer>
</div>

<script>
const csvURL="https://docs.google.com/spreadsheets/d/e/2PACX-1vTKpBKtR4FPQlTcRkMLLoyfPpsINfTUph6ZY-fZ15VlYmh5QGoOYZstOigBcCzIM3tWiMElXgrC7rIs/pub?gid=529778447&single=true&output=csv";
let barChart, pieChart, centerPieChart, lineChart;
let centersData = [];

function updateDashboard(){
    const liveURL = csvURL + "&cache=" + new Date().getTime();

    Papa.parse(liveURL, {
        download: true,
        complete: (res) => {
            const rows = res.data.filter(r => r.length > 3);
            if(rows.length < 2) return;

            const GT = rows[rows.length-1];
            document.getElementById("tTarget").innerText = (+GT[1]||0).toLocaleString();
            document.getElementById("tAch").innerText = (+GT[2]||0).toLocaleString();
            document.getElementById("tPct").innerText = GT[3] || "0%";
            document.getElementById("tDelta").innerText = ((+GT[1]||0) - (+GT[2]||0)).toLocaleString();
            document.getElementById("tB2B").innerText = (+GT[4]||0).toLocaleString();
            document.getElementById("syncTime").innerText = new Date().toLocaleTimeString();

            centersData = [];
            for(let i=1; i<rows.length-1; i++){
                const r = rows[i];
                const t = +r[1]||0;
                const a = +r[2]||0;
                const b2b = +r[4]||0;
                const p = t > 0 ? (a/t)*100 : 0;
                const trophyName = p >= 100 ? "üèÜ " + r[0] : r[0];
                
                centersData.push({ 
                    name: r[0], 
                    displayName: trophyName,
                    target: t, 
                    achieved: a, 
                    remaining: Math.max(0, t - a),
                    pct: p, 
                    b2b: b2b
                });
            }

            const sortedData = [...centersData].sort((a,b) => b.pct - a.pct);

            // 1. LINE CHART (B2B) - Set to not maintain aspect ratio for scroll
            if(lineChart){
                lineChart.data.labels = centersData.map(d => d.name);
                lineChart.data.datasets[0].data = centersData.map(d => d.b2b);
                lineChart.update('none');
            } else {
                lineChart = new Chart(document.getElementById("lineChart"), {
                    type: 'line',
                    data: {
                        labels: centersData.map(d => d.name),
                        datasets: [{ 
                            label: 'B2B Forms', 
                            data: centersData.map(d => d.b2b), 
                            borderColor: '#fb923c', 
                            backgroundColor: 'rgba(251, 146, 60, 0.2)', 
                            fill: true, 
                            tension: 0.3,
                            borderWidth: 3,
                            pointRadius: 5,
                            pointBackgroundColor: '#fb923c'
                        }]
                    },
                    options: { 
                        maintainAspectRatio: false, 
                        plugins: { 
                            legend: { display: false },
                            datalabels: { color: '#fff', align: 'top', font: {weight: 'bold'} }
                        },
                        scales: {
                            x: { ticks: { color: '#94a3b8', font: {size: 11} }, grid: { display: false } },
                            y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }

            // 2. STACKED PROGRESS BARS
            if(barChart){
                barChart.data.labels = sortedData.map(d => d.displayName);
                barChart.data.datasets[0].data = sortedData.map(d => d.achieved);
                barChart.data.datasets[1].data = sortedData.map(d => d.remaining);
                barChart.update('none');
            } else {
                barChart = new Chart(document.getElementById("bar"), {
                    type:'bar',
                    data:{
                        labels: sortedData.map(d=>d.displayName),
                        datasets:[
                            { label:'Achieved', data:sortedData.map(d=>d.achieved), backgroundColor:'#38bdf8', borderRadius:5 },
                            { label:'Remaining', data:sortedData.map(d=>d.remaining), backgroundColor:'rgba(255,255,255,0.08)', borderRadius:5 }
                        ]
                    },
                    options:{
                        indexAxis:'y', maintainAspectRatio:false,
                        scales:{ 
                            x:{ stacked: true, display: false }, 
                            y:{ stacked: true, ticks:{ color:'#f1f5f9', font:{size:12, weight: '600'} }, grid:{ display: false } } 
                        },
                        plugins:{ 
                            legend: { display: false },
                            datalabels: { 
                                color: '#fff', 
                                formatter: (val, ctx) => ctx.datasetIndex === 0 ? (val > 0 ? val.toLocaleString() : '') : '' 
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }

            // 3. PIE CHART
            if(pieChart){
                pieChart.data.datasets[0].data = [(+GT[2]||0), Math.max(0, (+GT[1]||0)-(+GT[2]||0))];
                pieChart.update('none');
            } else {
                pieChart = new Chart(document.getElementById("pie"), {
                    type:'doughnut',
                    data:{labels:['Achieved','Pending'], datasets:[{data:[1,1], backgroundColor:['#38bdf8','rgba(255,255,255,0.05)'], borderWidth:0}]},
                    options:{maintainAspectRatio:false, cutout:'85%', plugins:{legend:{display:false}, datalabels:{display:false}}}
                });
            }

            // Dropdown Update
            const select = document.getElementById("centerSelect");
            if(select.options.length <= 1){
                [...centersData].sort((a,b)=>a.name.localeCompare(b.name)).forEach(c => {
                    let opt=document.createElement("option"); opt.value=c.name; opt.innerText=c.name; select.appendChild(opt);
                });
            }
        }
    });
}

document.getElementById("centerSelect").addEventListener("change", function(){
    const c = centersData.find(d => d.name === this.value);
    if(!c) return;
    document.getElementById("cAch").innerText = c.achieved;
    document.getElementById("cB2B").innerText = c.b2b;
});

updateDashboard();
setInterval(updateDashboard, 500);
</script>
</body>
</html>