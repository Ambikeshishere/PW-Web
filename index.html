<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PW Target Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
    :root {
        --bg-dark: #020617;
        --card-bg: rgba(30, 41, 59, 0.6);
        --card-border: rgba(148, 163, 184, 0.1);
        --accent-primary: #38bdf8;
        --success: #4ade80;
        --text-main: #f1f5f9;
        --text-muted: #94a3b8;
    }

    * { box-sizing: border-box; }
    body {
        margin: 0; padding: 0;
        background-color: var(--bg-dark);
        background-image: radial-gradient(at 0% 0%, rgba(56, 189, 248, 0.1) 0px, transparent 50%);
        font-family: 'Outfit', sans-serif;
        color: var(--text-main);
        padding-bottom: 40px;
    }

    header { padding: 20px; text-align: center; }
    h1 {
        font-size: 26px; font-weight: 700; margin: 0;
        background: linear-gradient(90deg, #fb923c, #38bdf8);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }

    .container { padding: 15px; max-width: 1200px; margin: 0 auto; }
    .grid { display: grid; gap: 15px; }
    @media(min-width: 768px) { .grid-2 { grid-template-columns: 1fr 1fr; } .grid-4 { grid-template-columns: repeat(4, 1fr); } }

    .card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        backdrop-filter: blur(10px);
        border-radius: 16px; padding: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .card h3 { margin: 0 0 15px 0; font-size: 16px; border-left: 3px solid var(--accent-primary); padding-left: 10px; }

    .kpi-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
    .kpi-card { background: rgba(15, 23, 42, 0.6); border-radius: 12px; padding: 12px; text-align: center; border: 1px solid var(--card-border); }
    .kpi-label { font-size: 10px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 4px; }
    .kpi-value { font-size: 18px; font-weight: 700; }

    select {
        width: 100%; padding: 12px; border-radius: 10px; background: #1e293b; color: white;
        border: 1px solid #334155; margin-bottom: 15px; font-family: inherit;
    }

    .chart-wrapper-scroll { width: 100%; overflow-y: auto; max-height: 500px; }
    .chart-inner-tall { position: relative; min-height: 1000px; width: 100%; }
    .chart-box { height: 250px; width: 100%; }

    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { text-align: left; color: var(--text-muted); padding: 10px 5px; border-bottom: 1px solid #334155; }
    td { padding: 10px 5px; border-bottom: 1px solid rgba(51, 65, 85, 0.4); }

    .badge { padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 700; }
    .badge-success { background: rgba(74, 222, 128, 0.2); color: #4ade80; }

    footer { text-align: center; font-size: 11px; color: #475569; margin-top: 30px; }
</style>
</head>

<body>

<header>
    <h1>PW Vidyapeeth Dashboard</h1>
    <div style="font-size:12px; color:#94a3b8">Performance Tracking System</div>
</header>

<div class="container">
    <div class="kpi-grid grid-4">
        <div class="kpi-card"><div class="kpi-label">Total Target</div><div class="kpi-value" id="tTarget">0</div></div>
        <div class="kpi-card"><div class="kpi-label">Achieved</div><div class="kpi-value" style="color:#38bdf8" id="tAch">0</div></div>
        <div class="kpi-card"><div class="kpi-label">Achievement %</div><div class="kpi-value" style="color:#4ade80" id="tPct">0%</div></div>
        <div class="kpi-card"><div class="kpi-label">Delta</div><div class="kpi-value" id="tDelta">0</div></div>
    </div>

    <div class="grid grid-2">
        <div class="card">
            <h3>üìä Center Performance (Sorted)</h3>
            <div class="chart-wrapper-scroll">
                <div class="chart-inner-tall"><canvas id="bar"></canvas></div>
            </div>
        </div>
        <div class="card">
            <h3>üìà Overall Progress</h3>
            <div class="chart-box"><canvas id="pie"></canvas></div>
            
            <h3 style="margin-top:20px">üîç Center Lookup</h3>
            <select id="centerSelect"><option value="">Loading...</option></select>
            <div class="kpi-grid">
                <div class="kpi-card"><div class="kpi-label">Target</div><div class="kpi-value" id="cTarget">-</div></div>
                <div class="kpi-card"><div class="kpi-label">Achieved</div><div class="kpi-value" id="cAch">-</div></div>
            </div>
            <div class="chart-box" style="height:150px"><canvas id="centerPie"></canvas></div>
        </div>
    </div>

    <div class="grid grid-2" style="margin-top:15px">
        <div class="card">
            <h3>üèÜ Top 5 Centers</h3>
            <table><thead><tr><th>Center</th><th>%</th><th>Target</th></tr></thead><tbody id="topBody"></tbody></table>
        </div>
        <div class="card">
            <h3>‚ö†Ô∏è Zero Achievement</h3>
            <table><thead><tr><th>Center</th><th>Target</th></tr></thead><tbody id="zeroBody"></tbody></table>
        </div>
    </div>
    <footer>¬© 2026 Physics Wallah ‚Ä¢ Last Refresh: <span id="syncTime"></span></footer>
</div>

<script>
const csvURL="https://docs.google.com/spreadsheets/d/e/2PACX-1vTKpBKtR4FPQlTcRkMLLoyfPpsINfTUph6ZY-fZ15VlYmh5QGoOYZstOigBcCzIM3tWiMElXgrC7rIs/pub?gid=529778447&single=true&output=csv";
let barChart, pieChart, centerPieChart;
let centersData = [];

function updateDashboard(){
    Papa.parse(csvURL, {
        download: true,
        complete: (res) => {
            const rows = res.data.filter(r => r.length > 1);
            if(rows.length < 2) return;

            const GT = rows[rows.length-1];
            document.getElementById("tTarget").innerText = (+GT[1]||0).toLocaleString();
            document.getElementById("tAch").innerText = (+GT[2]||0).toLocaleString();
            document.getElementById("tPct").innerText = GT[3] || "0%";
            document.getElementById("tDelta").innerText = (+GT[4]||0).toLocaleString();
            document.getElementById("syncTime").innerText = new Date().toLocaleTimeString();

            // Data Processing with Trophy & Sorting
            centersData = [];
            for(let i=1; i<rows.length-1; i++){
                const r = rows[i];
                const t = +r[1]||0;
                const a = +r[2]||0;
                const p = t > 0 ? (a/t)*100 : 0;
                // Add Trophy if 100% or more
                const displayName = p >= 100 ? "üèÜ " + r[0] : r[0];
                
                centersData.push({ name: r[0], display: displayName, target: t, achieved: a, pct: p });
            }

            // SORT: Highest Achievement first
            centersData.sort((a,b) => b.pct - a.pct);

            const labels = centersData.map(d => d.display);
            const targets = centersData.map(d => d.target);
            const achieved = centersData.map(d => d.achieved);

            // Bar Chart Update
            if(barChart){
                barChart.data.labels = labels;
                barChart.data.datasets[0].data = achieved;
                barChart.data.datasets[1].data = targets;
                barChart.update();
            } else {
                barChart = new Chart(document.getElementById("bar"), {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Achieved', data: achieved, backgroundColor: '#38bdf8', order: 1, grouped: false, barPercentage: 0.6, borderRadius: 4 },
                            { label: 'Target', data: targets, backgroundColor: '#334155', order: 2, grouped: false, barPercentage: 0.6, borderRadius: 4 }
                        ]
                    },
                    options: {
                        indexAxis: 'y', maintainAspectRatio: false,
                        plugins: {
                            legend: { labels: { color: '#94a3b8', font: {family:'Outfit'} } },
                            datalabels: {
                                color: '#fff',
                                font: { weight: 'bold', size: 10 },
                                formatter: (val, ctx) => {
                                    // Index 0 is Blue (Achieved), Index 1 is Grey (Target)
                                    if(ctx.datasetIndex === 0) return val > 0 ? val.toLocaleString() : '';
                                    if(ctx.datasetIndex === 1) return 'Target: ' + val.toLocaleString();
                                },
                                anchor: 'end', align: 'end'
                            }
                        },
                        scales: {
                            x: { display: false },
                            y: { ticks: { color: '#cbd5e1', font: {family:'Outfit'} }, grid: { display: false } }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }

            // Update Tables & Select
            const select = document.getElementById("centerSelect");
            if(select.options.length <= 1){
                select.innerHTML = '<option value="">-- Select Center --</option>';
                centersData.forEach(c => { let opt=document.createElement("option"); opt.value=c.name; opt.innerText=c.name; select.appendChild(opt); });
            }

            let topH = "";
            centersData.slice(0,5).forEach(c => {
                topH += `<tr><td>${c.display}</td><td><span class="badge badge-success">${c.pct.toFixed(1)}%</span></td><td>${c.target}</td></tr>`;
            });
            document.getElementById("topBody").innerHTML = topH;

            let zeroH = "";
            centersData.filter(c => c.achieved === 0).forEach(c => {
                zeroH += `<tr><td style="color:#f87171">${c.name}</td><td>${c.target}</td></tr>`;
            });
            document.getElementById("zeroBody").innerHTML = zeroH || "<tr><td colspan='2'>No zero achievers!</td></tr>";
        }
    });
}

document.getElementById("centerSelect").addEventListener("change", function(){
    const c = centersData.find(d => d.name === this.value);
    if(!c) return;
    document.getElementById("cTarget").innerText = c.target.toLocaleString();
    document.getElementById("cAch").innerText = c.achieved.toLocaleString();
    
    const rem = Math.max(0, c.target - c.achieved);
    if(centerPieChart){
        centerPieChart.data.datasets[0].data = [c.achieved, rem];
        centerPieChart.update();
    } else {
        centerPieChart = new Chart(document.getElementById("centerPie"), {
            type:'doughnut',
            data: { labels:['Achieved','Rem'], datasets:[{data:[c.achieved, rem], backgroundColor:['#38bdf8','#1e293b'], borderWidth:0}]},
            options: { maintainAspectRatio:false, cutout:'70%', plugins:{ legend:{display:false}, datalabels:{display:false} }}
        });
    }
});

updateDashboard();
setInterval(updateDashboard, 6000);
</script>
</body>
</html>