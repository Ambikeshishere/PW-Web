<!DOCTYPE html>
<html>
<head>
<title>PW Target Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"> 
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body{
  margin:0;
  padding:15px;
  background:#020617;
  font-family:Inter,system-ui;
  color:white;
}
h1{
  font-size:24px;
  background:linear-gradient(90deg,#fb923c,#38bdf8);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  margin-bottom:5px;
}
.sub{color:#94a3b8;margin-bottom:20px; font-size: 14px;}

/* KPI cards */
.kpis{
  display:grid;
  grid-template-columns: repeat(2, 1fr);
  gap:12px;
  margin-bottom:20px;
}
@media (min-width: 768px) {
  .kpis { grid-template-columns: repeat(4, 1fr); }
  h1 { font-size: 32px; }
  body { padding: 30px; }
}
.card{
  background:#020617;
  border:1px solid #1e293b;
  border-radius:16px;
  padding:15px;
  box-shadow:0 0 25px rgba(56,189,248,.1);
  display:flex;
  flex-direction:column;
  justify-content:center;
}

/* KPI card alignment */
.card .label {
  display:block;
  text-align:center;
  margin-bottom:5px;
}
.card .big {
  text-align:center;
  font-size:22px;
  font-weight:700;
  margin-top:0px;
}

/* Card uniform height */
.kpis .card, .center-kpis .card { min-height:100px; }
.grid > .card { min-height:360px; }
.chart-container { flex:1; min-height:250px; }

.label{color:#94a3b8; font-size:12px; text-transform:uppercase; letter-spacing:0.5px;}
.grid{display:grid; grid-template-columns:1fr; gap:20px;}
@media (min-width:1024px){.grid{grid-template-columns:2fr 1fr;}}
.chart-container{position:relative;height:300px;width:100%;}
h3{font-size:16px;margin-top:0;color:#f8fafc;}
select{
  width:100%; padding:8px; border-radius:8px; background:#020617; color:white; border:1px solid #1e293b; margin-bottom:10px;
}
.center-kpis{display:grid; grid-template-columns:repeat(2,1fr); gap:12px;}
.center-kpis .card{padding:10px;}
@media (max-width:600px){.center-kpis{grid-template-columns:1fr;}}
table{width:100%; border-collapse:collapse; color:white;}
th, td{padding:6px; border-bottom:1px solid #334155;}
</style>
</head>

<body>

<h1>PW Target vs Achievement</h1>
<div class="sub">Live from Google Sheets</div>

<!-- Main KPIs -->
<div class="kpis">
  <div class="card"><div class="label">Total Target</div><div class="big" id="tTarget">0</div></div>
  <div class="card"><div class="label">Achieved</div><div class="big" id="tAch">0</div></div>
  <div class="card"><div class="label">Achievement %</div><div class="big" id="tPct">0%</div></div>
  <div class="card"><div class="label">Delta</div><div class="big" id="tDelta">0</div></div>
</div>

<!-- Main Charts -->
<div class="grid">
  <div class="card">
    <h3>Center wise Target vs Achieved</h3>
    <div class="chart-container">
        <canvas id="bar"></canvas>
    </div>
  </div>
  <div class="card">
    <h3>Achieved vs Remaining (Overall)</h3>
    <div class="chart-container">
        <canvas id="pie"></canvas>
    </div>
  </div>
</div>

<!-- Center mini-dashboard -->
<div class="grid" style="margin-top:20px;">
  <div class="card" style="grid-column:1 / -1;">
    <h3 id="centerPieTitle">Center Achieved vs Remaining</h3>
    <select id="centerSelect">
      <option value="">-- Select a Center --</option>
    </select>
    <div class="center-kpis">
      <div class="card"><div class="label">Target</div><div class="big" id="cTarget">0</div></div>
      <div class="card"><div class="label">Achieved</div><div class="big" id="cAch">0</div></div>
      <div class="card"><div class="label">Achievement %</div><div class="big" id="cPct">0%</div></div>
      <div class="card"><div class="label">Delta</div><div class="big" id="cDelta">0</div></div>
    </div>
    <div class="chart-container" style="margin-top:15px;">
      <canvas id="centerPie"></canvas>
    </div>
  </div>
</div>

<!-- Top Centers & Zero Achievement -->
<div class="grid" style="margin-top:20px; gap:20px;">
  <div class="card">
    <h3>Top Centers (by Achievement %)</h3>
    <table id="topCenters">
      <thead>
        <tr>
          <th>Center</th>
          <th>Achievement %</th>
          <th>Target</th>
          <th>Achieved</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card">
    <h3>Centers with 0 Achievement</h3>
    <table id="zeroCenters">
      <thead>
        <tr>
          <th>Center</th>
          <th>Target</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
const csvURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTKpBKtR4FPQlTcRkMLLoyfPpsINfTUph6ZY-fZ15VlYmh5QGoOYZstOigBcCzIM3tWiMElXgrC7rIs/pub?gid=529778447&single=true&output=csv";

let barChart, pieChart, centerPieChart;
let centersData = [];
let selectedCenter = "";

function updateDashboard() {
  Papa.parse(csvURL, {
    download: true,
    error: (err) => { console.error("CSV load failed:", err); },
    complete: (res) => {
      const rows = res.data.filter(r => r.length);
      if(rows.length < 2) return;

      const GT = rows[rows.length - 1];
      const totalTarget = +GT[1] || 0;
      const totalAchieved = +GT[2] || 0;
      const totalRemaining = totalTarget - totalAchieved;

      document.getElementById("tTarget").innerText = totalTarget.toLocaleString();
      document.getElementById("tAch").innerText = totalAchieved.toLocaleString();
      document.getElementById("tPct").innerText = GT[3] || "0%";
      document.getElementById("tDelta").innerText = (+GT[4] || 0).toLocaleString();

      centersData = [];
      const centers=[], target=[], achieved=[];
      for(let i=1; i<rows.length - 1; i++){
        const r = rows[i];
        if(!r || !r[0]) continue;
        centers.push(r[0]);
        target.push(+r[1] || 0);
        achieved.push(+r[2] || 0);
        const delta = (+r[1] || 0) - (+r[2] || 0);
        const pct = ((+r[2]||0)/(+r[1]||1)*100).toFixed(1)+"%";
        centersData.push({name: r[0], target: +r[1]||0, achieved: +r[2]||0, pct, delta});
      }

      const fontSize = Math.max(10, Math.min(14, window.innerWidth/50));

      // Horizontal bar chart with split names and highlight
      const barLabels = centers.map(c=>{
        const parts = c.split(" "); const mid=Math.ceil(parts.length/2);
        return parts.slice(0,mid).join(" ") + "\n" + parts.slice(mid).join(" ");
      });

      const barColorsTarget = centers.map(c=> c===selectedCenter ? "#facc15" : "#fb923c");
      const barColorsAch = centers.map(c=> c===selectedCenter ? "#22d3ee" : "#38bdf8");

      if(barChart){
        barChart.data.labels = barLabels;
        barChart.data.datasets[0].data = target;
        barChart.data.datasets[0].backgroundColor = barColorsTarget;
        barChart.data.datasets[1].data = achieved;
        barChart.data.datasets[1].backgroundColor = barColorsAch;
        barChart.update();
      } else {
        barChart = new Chart(document.getElementById("bar"),{
          type:"bar",
          data:{
            labels: barLabels,
            datasets:[
              {label:"Target", data: target, backgroundColor: barColorsTarget, barThickness:20},
              {label:"Achieved", data: achieved, backgroundColor: barColorsAch, barThickness:20}
            ]
          },
          options:{
            indexAxis: 'y',
            maintainAspectRatio:false,
            responsive:true,
            plugins:{
              legend:{labels:{color:"white", boxWidth:12}},
              datalabels:{color:"white", anchor:"end", align:"right", formatter: val=>val.toLocaleString(), font:{weight:"bold"}}
            },
            layout:{padding:{left:20,right:20}},
            scales:{
              x:{ticks:{color:"#94a3b8"}},
              y:{ticks:{color:"#94a3b8", autoSkip:false, font:{size:12}}}
            }
          },
          plugins:[ChartDataLabels]
        });
      }

      // Overall pie chart
      if(pieChart){
        pieChart.data.datasets[0].data = [totalAchieved, totalRemaining];
        pieChart.data.labels = ["Achieved","Remaining"];
        pieChart.update();
      } else {
        pieChart = new Chart(document.getElementById("pie"),{
          type:"pie",
          data:{labels:["Achieved","Remaining"], datasets:[{data:[totalAchieved,totalRemaining], backgroundColor:["#38bdf8","#fb923c"]}]},
          options:{maintainAspectRatio:false, plugins:{legend:{position:'bottom', labels:{color:"white"}}, datalabels:{color:"white", formatter: val=>val.toLocaleString(), font:{weight:"bold"}}}},
          plugins:[ChartDataLabels]
        });
      }

      // Dropdown
      const select = document.getElementById("centerSelect");
      select.innerHTML = '<option value="">-- Select a Center --</option>';
      centersData.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.name;
        opt.innerText = c.name;
        select.appendChild(opt);
      });

      // Top centers
      const topCenters = [...centersData].sort((a,b)=>parseFloat(b.pct)-parseFloat(a.pct)).slice(0,5);
      const topTbody = document.querySelector("#topCenters tbody");
      topTbody.innerHTML = "";
      topCenters.forEach(c=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${c.name}</td><td>${c.pct}</td><td>${c.target.toLocaleString()}</td><td>${c.achieved.toLocaleString()}</td>`;
        topTbody.appendChild(tr);
      });

      // Zero achievement
      const zeroCenters = centersData.filter(c=>c.achieved===0);
      const zeroTbody = document.querySelector("#zeroCenters tbody");
      zeroTbody.innerHTML = "";
      zeroCenters.forEach(c=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${c.name}</td><td>${c.target.toLocaleString()}</td>`;
        zeroTbody.appendChild(tr);
      });
    }
  });
}

// Center mini-dashboard
document.getElementById("centerSelect").addEventListener("change", function(){
  const cName = this.value;
  selectedCenter = cName; // highlight selected center
  const cData = centersData.find(c=>c.name===cName);
  if(!cData) return;

  const remaining = cData.target - cData.achieved;

  document.getElementById("centerPieTitle").innerText = `${cName} Achieved vs Remaining`;
  document.getElementById("cTarget").innerText = cData.target.toLocaleString();
  document.getElementById("cAch").innerText = cData.achieved.toLocaleString();
  document.getElementById("cPct").innerText = cData.pct;
  document.getElementById("cDelta").innerText = cData.delta.toLocaleString();

  if(centerPieChart){
    centerPieChart.data.datasets[0].data = [cData.achieved, remaining];
    centerPieChart.data.labels = ["Achieved","Remaining"];
    centerPieChart.update();
  } else {
    centerPieChart = new Chart(document.getElementById("centerPie"),{
      type:"pie",
      data:{labels:["Achieved","Remaining"], datasets:[{data:[cData.achieved, remaining], backgroundColor:["#38bdf8","#fb923c"]}]},
      options:{maintainAspectRatio:false, plugins:{legend:{position:'bottom', labels:{color:"white"}}, datalabels:{color:"white", formatter: val=>val.toLocaleString(), font:{weight:"bold"}}}},
      plugins:[ChartDataLabels]
    });
  }

  // Refresh bar chart to highlight selected center
  updateDashboard();
});

// Initial load
updateDashboard();
setInterval(updateDashboard,60000);
</script>

</body>
</html>
