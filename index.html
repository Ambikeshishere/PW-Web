<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PW Target Dashboard - Live</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
    :root {
        --bg-dark: #020617;
        --card-bg: rgba(30, 41, 59, 0.6);
        --card-border: rgba(148, 163, 184, 0.1);
        --accent-primary: #38bdf8;
        --success: #4ade80;
        --text-main: #f1f5f9;
        --text-muted: #94a3b8;
        --warning: #fb923c;
    }

    * { box-sizing: border-box; }
    body {
        margin: 0; padding: 0;
        background-color: var(--bg-dark);
        background-image: radial-gradient(at 0% 0%, rgba(56, 189, 248, 0.1) 0px, transparent 50%);
        font-family: 'Outfit', sans-serif;
        color: var(--text-main);
        padding-bottom: 40px;
    }

    header { padding: 20px; text-align: center; }
    h1 {
        font-size: 26px; font-weight: 700; margin: 0;
        background: linear-gradient(90deg, #fb923c, #38bdf8);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }

    .container { padding: 15px; max-width: 1200px; margin: 0 auto; }
    .grid { display: grid; gap: 15px; }
    @media(min-width: 768px) { .grid-2 { grid-template-columns: 1fr 1fr; } .grid-4 { grid-template-columns: repeat(4, 1fr); } }

    .card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        backdrop-filter: blur(10px);
        border-radius: 16px; padding: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .card h3 { margin: 0 0 15px 0; font-size: 16px; border-left: 3px solid var(--accent-primary); padding-left: 10px; }

    .kpi-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
    .kpi-card { background: rgba(15, 23, 42, 0.6); border-radius: 12px; padding: 12px; text-align: center; border: 1px solid var(--card-border); }
    .kpi-label { font-size: 10px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 4px; }
    .kpi-value { font-size: 18px; font-weight: 700; }

    select {
        width: 100%; padding: 12px; border-radius: 10px; background: #1e293b; color: white;
        border: 1px solid #334155; margin-bottom: 15px; font-family: inherit;
    }

    .chart-wrapper-scroll { width: 100%; overflow-y: auto; max-height: 500px; }
    .chart-inner-tall { position: relative; min-height: 1200px; width: 100%; }
    .chart-box { height: 250px; width: 100%; }

    .table-responsive { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 12px; min-width: 300px; }
    th { text-align: left; color: var(--text-muted); padding: 10px 5px; border-bottom: 1px solid #334155; white-space: nowrap; }
    td { padding: 10px 5px; border-bottom: 1px solid rgba(51, 65, 85, 0.4); }

    .badge { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 700; }
    .badge-success { background: rgba(74, 222, 128, 0.2); color: #4ade80; }
    .badge-danger { background: rgba(248, 113, 113, 0.2); color: #f87171; }

    .live-dot {
        height: 8px; width: 8px; background-color: #4ade80;
        border-radius: 50%; display: inline-block; margin-right: 5px;
        animation: pulse 1.5s infinite;
    }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

    footer { text-align: center; font-size: 11px; color: #475569; margin-top: 30px; }
</style>
</head>

<body>

<header>
    <h1>PW Vidyapeeth Dashboard</h1>
    <div style="font-size:12px; color:#94a3b8"><span class="live-dot"></span>Real-Time Performance Tracker</div>
</header>

<div class="container">
    <div class="kpi-grid grid-4">
        <div class="kpi-card"><div class="kpi-label">Total Target</div><div class="kpi-value" id="tTarget">0</div></div>
        <div class="kpi-card"><div class="kpi-label">Total Achieved</div><div class="kpi-value" style="color:#38bdf8" id="tAch">0</div></div>
        <div class="kpi-card"><div class="kpi-label">Achievement %</div><div class="kpi-value" style="color:#4ade80" id="tPct">0%</div></div>
        <div class="kpi-card"><div class="kpi-label">Total Delta</div><div class="kpi-value" style="color:#fb923c" id="tDelta">0</div></div>
    </div>

    <div class="grid grid-2">
        <div class="card">
            <h3>üìä Center Performance</h3>
            <div class="chart-wrapper-scroll">
                <div class="chart-inner-tall"><canvas id="bar"></canvas></div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h3>üìà Overall Progress</h3>
                <div class="chart-box"><canvas id="pie"></canvas></div>
            </div>

            <div class="card">
                <h3>üîç Center Analysis</h3>
                <select id="centerSelect"><option value="">Loading Data...</option></select>
                <div class="kpi-grid">
                    <div class="kpi-card"><div class="kpi-label">Target</div><div class="kpi-value" id="cTarget">-</div></div>
                    <div class="kpi-card"><div class="kpi-label">Achieved</div><div class="kpi-value" id="cAch">-</div></div>
                    <div class="kpi-card"><div class="kpi-label">Achieved %</div><div class="kpi-value" style="color:#4ade80" id="cPct">-</div></div>
                    <div class="kpi-card"><div class="kpi-label">Delta (Gap)</div><div class="kpi-value" style="color:#fb923c" id="cDelta">-</div></div>
                </div>
                <div class="chart-box" style="height:120px"><canvas id="centerPie"></canvas></div>
            </div>
        </div>
    </div>

    <div class="grid grid-2" style="margin-top:15px">
        <div class="card">
            <h3>üèÜ Top 5 Centers</h3>
            <div class="table-responsive">
                <table>
                    <thead><tr><th>Center</th><th>%</th><th>Target</th><th>Achieved</th></tr></thead>
                    <tbody id="topBody"></tbody>
                </table>
            </div>
        </div>
        <div class="card">
            <h3>‚ö†Ô∏è Zero Achievement</h3>
            <div class="table-responsive">
                <table>
                    <thead><tr><th>Center</th><th>Target</th><th>Achieved</th></tr></thead>
                    <tbody id="zeroBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    <footer>¬© Developed by Ambikesh Srivastava ‚Ä¢ Auto-refreshing every 5s ‚Ä¢ Last Sync: <span id="syncTime"></span></footer>
</div>

<script>
const csvURL="https://docs.google.com/spreadsheets/d/e/2PACX-1vTKpBKtR4FPQlTcRkMLLoyfPpsINfTUph6ZY-fZ15VlYmh5QGoOYZstOigBcCzIM3tWiMElXgrC7rIs/pub?gid=529778447&single=true&output=csv";
let barChart, pieChart, centerPieChart;
let centersData = [];

function updateDashboard(){
    Papa.parse(csvURL, {
        download: true,
        complete: (res) => {
            const rows = res.data.filter(r => r.length > 1);
            if(rows.length < 2) return;

            const GT = rows[rows.length-1];
            const tT = +GT[1]||0;
            const tA = +GT[2]||0;
            
            document.getElementById("tTarget").innerText = tT.toLocaleString();
            document.getElementById("tAch").innerText = tA.toLocaleString();
            document.getElementById("tPct").innerText = GT[3] || "0%";
            document.getElementById("tDelta").innerText = (tT - tA).toLocaleString();
            
            // Sync time now includes seconds for visual feedback of the 5s refresh
            document.getElementById("syncTime").innerText = new Date().toLocaleTimeString();

            centersData = [];
            for(let i=1; i<rows.length-1; i++){
                const r = rows[i];
                const t = +r[1]||0;
                const a = +r[2]||0;
                const p = t > 0 ? (a/t)*100 : 0;
                centersData.push({ 
                    name: r[0], 
                    display: p >= 100 ? "üèÜ " + r[0] : r[0], 
                    target: t, 
                    achieved: a, 
                    pct: p, 
                    delta: Math.max(0, t - a) 
                });
            }

            // Keep sorting consistent
            centersData.sort((a,b) => b.pct - a.pct);

            // 1. Overall Pie Update (Using 'none' to prevent animation loops)
            if(pieChart){
                pieChart.data.datasets[0].data = [tA, Math.max(0, tT-tA)];
                pieChart.update('none');
            } else {
                pieChart = new Chart(document.getElementById("pie"), {
                    type:'doughnut',
                    data:{labels:['Achieved','Remaining'], datasets:[{data:[tA, tT-tA], backgroundColor:['#38bdf8','#1e293b'], borderWidth:0}]},
                    options:{maintainAspectRatio:false, cutout:'75%', plugins:{legend:{position:'bottom', labels:{color:'#fff', font:{size:10}}}, datalabels:{color:'#fff', font:{weight:'bold'}, formatter:v=>v.toLocaleString()}}},
                    plugins:[ChartDataLabels]
                });
            }

            // 2. Bar Chart Update
            const labels = centersData.map(d => d.display);
            if(barChart){
                barChart.data.labels = labels;
                barChart.data.datasets[0].data = centersData.map(d => d.achieved);
                barChart.data.datasets[1].data = centersData.map(d => d.target);
                barChart.update('none');
            } else {
                barChart = new Chart(document.getElementById("bar"), {
                    type:'bar',
                    data:{
                        labels: labels,
                        datasets:[
                            { label:'Achieved', data:centersData.map(d=>d.achieved), backgroundColor:'#38bdf8', order:1, grouped:false, barPercentage:0.6, borderRadius:4 },
                            { label:'Target', data:centersData.map(d=>d.target), backgroundColor:'#334155', order:2, grouped:false, barPercentage:0.6, borderRadius:4 }
                        ]
                    },
                    options:{
                        indexAxis:'y', maintainAspectRatio:false,
                        plugins:{
                            legend:{labels:{color:'#94a3b8'}},
                            datalabels:{
                                color:'#fff', font:{size:9, weight:'bold'},
                                formatter:(v, ctx) => ctx.datasetIndex === 0 ? (v>0 ? v.toLocaleString() : '') : 'Target: '+v.toLocaleString(),
                                anchor:'end', align:'end'
                            }
                        },
                        scales:{ x:{display:false}, y:{ticks:{color:'#cbd5e1', font:{size:10}}, grid:{display:false}}}
                    },
                    plugins:[ChartDataLabels]
                });
            }

            // 3. Dropdown (Populate only once)
            const select = document.getElementById("centerSelect");
            if(select.options.length <= 1){
                select.innerHTML = '<option value="">-- Select Center --</option>';
                [...centersData].sort((a,b)=>a.name.localeCompare(b.name)).forEach(c => {
                    let opt=document.createElement("option"); opt.value=c.name; opt.innerText=c.name; select.appendChild(opt);
                });
            }

            // 4. Tables Update
            document.getElementById("topBody").innerHTML = centersData.slice(0,5).map(c => `
                <tr>
                    <td>${c.display}</td>
                    <td><span class="badge badge-success">${c.pct.toFixed(1)}%</span></td>
                    <td>${c.target.toLocaleString()}</td>
                    <td>${c.achieved.toLocaleString()}</td>
                </tr>
            `).join('');

            const zeroAch = centersData.filter(c => c.achieved === 0);
            document.getElementById("zeroBody").innerHTML = zeroAch.length > 0 ? zeroAch.map(c => `
                <tr>
                    <td style="color:#f87171">${c.name}</td>
                    <td>${c.target.toLocaleString()}</td>
                    <td><span class="badge badge-danger">${c.achieved}</span></td>
                </tr>
            `).join('') : "<tr><td colspan='3' style='text-align:center'>No zero achievers!</td></tr>";
        }
    });
}

// Single Center Selection Update
document.getElementById("centerSelect").addEventListener("change", function(){
    const c = centersData.find(d => d.name === this.value);
    if(!c) return;
    document.getElementById("cTarget").innerText = c.target.toLocaleString();
    document.getElementById("cAch").innerText = c.achieved.toLocaleString();
    document.getElementById("cPct").innerText = c.pct.toFixed(1) + "%";
    document.getElementById("cDelta").innerText = c.delta.toLocaleString();
    
    if(centerPieChart){
        centerPieChart.data.datasets[0].data = [c.achieved, c.delta];
        centerPieChart.update();
    } else {
        centerPieChart = new Chart(document.getElementById("centerPie"), {
            type:'doughnut',
            data: { labels:['Achieved','Pending'], datasets:[{data:[c.achieved, c.delta], backgroundColor:['#38bdf8','#1e293b'], borderWidth:0}]},
            options: { maintainAspectRatio:false, cutout:'70%', plugins:{ legend:{display:false}, datalabels:{display:false} }}
        });
    }
});

// Run immediately on load
updateDashboard();

// Auto-Refresh Logic (5000ms = 5s)
setInterval(updateDashboard, 500);
</script>
</body>
</html>